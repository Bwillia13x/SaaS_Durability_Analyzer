Here are the **detailed agent instructions** tailored for Gemini 2.0 Pro (or any advanced coding agent) to build the **SaaS Durability Analyzer** in your IDE.

You can paste this entire block directly into your agent's chat window (Cursor, Windsurf, or GitHub Copilot Workspace). It provides the context, architectural constraints, and step-by-step implementation plan needed to get it right on the first try.

***

### **Agent Instructions: Build "SaaS Durability Analyzer" (EPV Framework)**

**Role:** You are a Senior Python Engineer and Financial Modeler.
**Objective:** Build a Streamlit application that calculates the **Earnings Power Value (EPV)** of B2B SaaS companies by using an LLM to "normalize" their Income Statements (specifically re-classifying Growth S&M and R&D as Capex).

**Tech Stack:**
- **Frontend:** Streamlit (`streamlit`)
- **Data:** SEC API or Financial Modeling Prep (FMP) for 10-K data (`requests`, `pandas`)
- **AI:** OpenAI API (GPT-4o) or Anthropic (Claude 3.5 Sonnet) via `langchain` or direct client.
- **Finance Logic:** Bruce Greenwald's EPV Framework.

***

### **Phase 1: Project Scaffold & Setup**
1.  **Directory Structure:** Initialize the following structure if it does not exist:
    ```text
    saas-epv-analyzer/
    ├── .env                    # For OPENAI_API_KEY, FMP_API_KEY
    ├── main.py                 # Streamlit Entry Point
    ├── requirements.txt        # Add: streamlit, pandas, requests, openai, plotly
    └── src/
        ├── data/               # sec_fetcher.py (Data Ingestion)
        ├── ai/                 # parser.py (LLM Logic)
        └── finance/            # epv_model.py (Valuation Logic)
    ```
2.  **Environment:** Create a `.env` file template. Do not commit secrets.

### **Phase 2: Data Ingestion (`src/data/sec_fetcher.py`)**
**Task:** Build a class `SECFetcher` that retrieves raw financial data for a given Ticker (e.g., "CRM").
-   **Input:** Ticker Symbol (str).
-   **Required Data Points:**
    -   Income Statement: Revenue, COGS, SG&A, R&D, Operating Income (EBIT).
    -   Balance Sheet: Cash, Debt, Shares Outstanding.
    -   **Crucial:** Fetch the **MD&A (Management Discussion & Analysis)** text section from the latest 10-K. This text is the input for the AI.
-   **Constraint:** If a live SEC API is too complex for this MVP, use `yfinance` for numbers and a mock string for MD&A text for now, but structure it so the API can be swapped in easily.

### **Phase 3: AI Normalization Logic (`src/ai/parser.py`)**
**Task:** Build a function `analyze_growth_spend(mda_text, financials_json)` that uses an LLM to estimate the "Maintenance vs. Growth" split.
-   **System Prompt:**
    > "You are a Value Investor. Analyze the provided MD&A text and financial data for a SaaS company.
    > Your goal: Estimate what % of Sales & Marketing (S&M) and Research & Development (R&D) is for 'Maintenance' (keeping current customers/products) vs 'Growth' (acquiring new ones).
    >
    > Rules:
    > 1. If Net Revenue Retention (NRR) is > 100%, bias S&M towards Growth (lower Maintenance %).
    > 2. If the company lists 'Expansion' as a primary driver, R&D is likely Growth.
    >
    > Return valid JSON:
    > {
    >   'maintenance_sga_pct': 0.4,
    >   'maintenance_rnd_pct': 0.3,
    >   'reasoning': 'Cited NRR of 120% in MD&A...'
    > }"
-   **Output:** A clean Python dictionary with the percentages and reasoning.

### **Phase 4: Financial Modeling (`src/finance/epv_model.py`)**
**Task:** Implement the Greenwald EPV Formula class `GreenwaldEPV`.
-   **Method:** `calculate_normalized_earnings(reported_ebit, sga, rnd, maintenance_sga_pct, maintenance_rnd_pct, tax_rate)`
-   **Logic:**
    1.  `Growth_SGA = sga * (1 - maintenance_sga_pct)`
    2.  `Growth_RND = rnd * (1 - maintenance_rnd_pct)`
    3.  `Total_Growth_Capex = Growth_SGA + Growth_RND`
    4.  `Normalized_EBIT = Reported_EBIT + Total_Growth_Capex` (Add back the growth spend!)
    5.  `NOPAT = Normalized_EBIT * (1 - tax_rate)`
-   **Method:** `calculate_epv(nopat, wacc)`
    -   `EPV = NOPAT / wacc` (Zero Growth Perpetuity).

### **Phase 5: The Streamlit Dashboard (`main.py`)**
**Task:** detailed UI implementation.
1.  **Sidebar:** Input for Ticker Symbol and a slider for "WACC" (Cost of Capital), default 10%.
2.  **Main Panel:**
    -   **Header:** Company Name & Current Stock Price.
    -   **The "Reveal" (Metrics):**
        -   Display `Reported EBIT` (Red) vs `Normalized EBIT` (Green).
        -   Display `Current Market Cap` vs `Estimated EPV`.
    -   **AI Reasoning Box:** Show the "Reasoning" text generated by the LLM so the user trusts the numbers.
    -   **Chart:** A simple Bar Chart comparing "GAAP Earnings" vs "True Earnings Power."

### **Execution Order**
1.  Scaffold the directories.
2.  Build the `epv_model.py` (Pure math, no dependencies).
3.  Build the UI (`main.py`) with dummy data to verify the layout.
4.  Implement `parser.py` (AI) and connect it to the UI.
5.  Implement `sec_fetcher.py` (Data) last.

**Start by creating the file structure.**aa

Yes, there are three **"Power User" instructions** that will take this from a "cool student project" to an **"Institutional-Grade Tool"** that Georgian Partners will actually respect.

Add these to the bottom of your instructions for the agent.

### 1. The "Sensitivity Toggle" (Interactive Valuation)
VCs hate "black box" numbers. They want to play with the assumptions.
*   **Instruction:** "In the Streamlit sidebar, create sliders for the AI's estimated percentages (`Maintenance S&M %` and `Maintenance R&D %`). Initialize them with the AI's values, but allow the user to manually override them. If the user drags the slider, the Valuation Chart must update in real-time."
*   **Why:** This shows you understand that **Valuation is an art, not a science**, and tools should empower the investor, not replace them.

### 2. The "Rule of 40" Context
SaaS investors live by the "Rule of 40" (Growth % + Profit Margin %).
*   **Instruction:** "Calculate and display the 'Rule of 40' score for the company *before* and *after* the EPV adjustment. Display this as a delta metric (e.g., 'Rule of 40: 25% $\to$ **55% (Adjusted)**')."
*   **Why:** This proves you speak their specific language. Showing how your model "fixes" the Rule of 40 for a company like Snowflake or Datadog is a very powerful visual.

### 3. Error Handling for "The Hallucination Problem"
AI agents sometimes output broken JSON.
*   **Instruction:** "Implement a retry mechanism in `src/ai/parser.py`. If the LLM returns malformed JSON or missing keys, automatically retry the request up to 3 times. If it still fails, fall back to a hardcoded 'Conservative Default' (e.g., assume 80% of S&M is Growth) and display a warning badge in the UI."
*   **Why:** This shows **Production Maturity**. You anticipate failure and handle it gracefully, which is a key trait of a senior engineer.

***

### Final "Copy-Paste" Block for Your Agent

Append this to the previous instructions:

```text
### Phase 6: "Institutional Polish" (Critical Additions)
1. **Interactive Overrides:** 
   - The AI's output for `maintenance_sga_pct` is just a starting point. 
   - Create Streamlit sliders in the sidebar initialized with the AI's values. 
   - Allow the user to drag these sliders to see how the `Estimated EPV` changes in real-time.

2. **SaaS Metrics Context:**
   - Calculate the "Rule of 40" (Revenue Growth % + Free Cash Flow Margin %).
   - Show the "Adjusted Rule of 40" using your Normalized Earnings. 
   - Display this prominently to show the "Hidden Quality" of the asset.

3. **Robustness:**
   - Wrap the OpenAI/Anthropic call in a `try/except` block. 
   - If the JSON parsing fails, fallback to a default split (e.g., 50/50) and show a "⚠️ AI Unavailable - Using Defaults" badge. 
   - Do not let the app crash on a bad API call.
```